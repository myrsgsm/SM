<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Salesman - Royal Sherwani</title>
    
    <script>
        if (!window.crypto || !window.crypto.subtle || !window.crypto.getRandomValues) {
            const fakeCrypto = {
                getRandomValues: function(array) {
                    for (let i = 0; i < array.length; i++) array[i] = Math.floor(Math.random() * 256);
                    return array;
                },
                subtle: {
                    digest: function(algo, data) { return Promise.resolve(new Uint8Array(32)); }
                }
            };
            try { Object.defineProperty(window, 'crypto', { value: fakeCrypto, writable: true }); } 
            catch(e) { window.crypto = fakeCrypto; }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --gold: #D4AF37; --bg: #050505; --card: #141414; --text: #E0E0E0;
            --shop: #4CAF50; --godown: #FF9800; --transit: #2196F3; --packed: #9C27B0;
            --master: #FF9800; --done: #00E676; --red: #FF5252; --green: #4CAF50;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 0; padding-bottom: 80px; }
        
        /* --- LOGIN & CONSOLE STYLES --- */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 4000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .inp-login { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: white; border-radius: 6px; margin-bottom: 10px; font-size: 16px; }
        .btn-act-login { width: 100%; padding: 12px; background: var(--gold); border: none; font-weight: bold; border-radius: 6px; cursor: pointer; color: #000; font-family: 'Cinzel', serif; font-size: 16px; }
        
        #debug-console {
            background: #000; border: 1px solid #333; color: #0f0;
            font-family: monospace; font-size: 10px; padding: 10px;
            margin-top: 15px; width: 90%; max-width: 300px; height: 120px;
            overflow-y: auto; border-radius: 5px; text-align: left;
            display: block;
        }
        .log-err { color: #ff5555; font-weight: bold; border-bottom: 1px solid #550000; }
        .log-warn { color: #ffaa00; }
        .log-ok { color: #00ff00; }

        /* MODAL FOR KEYS (Z-INDEX FIX) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; justify-content: center; align-items: center; flex-direction: column; }
        .modal-card { background: var(--card); padding: 25px; border-radius: 16px; border: 2px solid var(--gold); width: 90%; max-width: 400px; text-align: center; }

        /* UTILS */
        .hidden { display: none !important; }
        
        /* HEADER */
        .header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #111; position: sticky; top: 0; z-index: 50; }
        .brand-text { font-family: 'Cinzel'; font-size: 16px; color: var(--gold); }
        .header-right { display: flex; align-items: center; gap: 10px; }

        /* STATUS LIGHT */
        .status-box { display: flex; align-items: center; gap: 6px; padding: 5px 10px; border-radius: 20px; border: 1px solid #333; font-size: 10px; font-weight: bold; background: #000; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #555; box-shadow: 0 0 5px rgba(0,0,0,0.5); transition: background 0.3s; }
        .dot.online { background: var(--green); box-shadow: 0 0 8px var(--green); }
        .dot.offline { background: var(--red); box-shadow: 0 0 8px var(--red); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .btn-logout { background: #333; border: 1px solid #555; color: white; padding: 6px 10px; border-radius: 6px; font-size: 10px; font-weight: bold; cursor: pointer; }
        .btn-icon { background: #333; border: 1px solid #444; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* TABS */
        .tabs { display: flex; gap: 5px; padding: 10px; background: #111; overflow-x: auto; position: sticky; top: 55px; z-index: 49; }
        .tab-btn { flex: 1; background: #222; border: 1px solid #444; color: #888; padding: 12px 5px; border-radius: 8px; font-size: 11px; white-space: nowrap; cursor: pointer; text-align: center; font-weight: bold; }
        .tab-btn.active { background: var(--gold); color: black; border-color: var(--gold); }

        /* INVENTORY SEARCH */
        .search-area { padding: 10px; display: flex; gap: 10px; }
        .search-input { flex: 1; background: #222; border: 1px solid #333; color: white; padding: 12px; border-radius: 10px; font-size: 16px; }
        .icon-btn { width: 50px; background: #333; border: 1px solid var(--gold); color: var(--gold); border-radius: 10px; font-size: 22px; cursor: pointer; }

        /* GRID */
        .design-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .design-card { background: var(--card); border: 1px solid #333; border-radius: 12px; overflow: hidden; position: relative; }
        .card-img { width: 100%; aspect-ratio: 1; object-fit: cover; }
        .qty-badge { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; border: 1px solid #555; }
        .card-body { padding: 10px; text-align: center; }
        .card-title { font-size: 13px; font-weight: bold; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* PACKED ORDERS (HIERARCHY) */
        .split-container { display: flex; gap: 10px; padding: 10px; align-items: flex-start; }
        .split-col { flex: 1; background: #111; padding: 5px; border-radius: 8px; border: 1px solid #333; min-height: 300px; }
        .col-title { font-size: 11px; font-weight: 900; color: #888; text-align: center; margin-bottom: 10px; text-transform: uppercase; border-bottom: 1px solid #333; padding: 8px 0; }

        /* Packet Card */
        .pkt-card { background: #1a1a1a; border: 1px solid #444; border-radius: 8px; margin-bottom: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .pkt-header { background: #252525; padding: 8px; color: var(--gold); font-weight: 900; font-size: 13px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .pkt-body { padding: 8px; }

        /* Bill Box */
        .bill-group { background: #000; border: 1px solid #333; border-radius: 6px; margin-bottom: 6px; padding: 8px; }
        .bill-header { font-size: 11px; font-weight: bold; color: #fff; margin-bottom: 4px; padding-bottom: 4px; border-bottom: 1px dashed #333; }
        
        /* Items */
        .item-row-packed { font-size: 10px; color: #ccc; display: flex; justify-content: space-between; padding: 2px 0; }
        .item-row-packed span { font-family: monospace; color: #666; }

        .btn-send { background: #333; color: white; border: 1px solid #555; font-size: 10px; padding: 8px; border-radius: 4px; width: 100%; cursor: pointer; margin-top: 8px; font-weight: bold; }
        .btn-send:active { background: var(--gold); color: black; }
        
        .transit-label { width: 100%; text-align: center; background: rgba(33, 150, 243, 0.1); border: 1px dashed var(--transit); color: var(--transit); font-size: 10px; padding: 8px; border-radius: 4px; margin-top: 8px; font-weight: bold; }

        /* MASTER JI */
        .master-card { background: #222; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid orange; }
        .master-card.done { border-left-color: var(--done); }

        /* MODALS */
        .modal-content { background: var(--card); border-radius: 16px; width: 95%; max-width: 450px; border: 1px solid var(--gold); max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .modal-img-area { position: relative; height: 300px; background: black; }
        .modal-img { width: 100%; height: 100%; object-fit: contain; }
        .stock-list { padding: 10px; overflow-y: auto; flex: 1; }
        .stock-item { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 12px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid #555; }
        .stock-item.shop { border-left-color: var(--shop); }
        .stock-item.godown { border-left-color: var(--godown); }

        /* SCANNER */
        #scanner-modal { background: black; z-index: 6000; }
        #reader { width: 100%; border: 2px solid var(--gold); }
        
        .loader { border: 4px solid #333; border-top: 4px solid var(--gold); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2 style="color:var(--gold); font-family:'Cinzel'; margin-bottom:20px;">SALES LOGIN</h2>
        <div style="width:280px;">
            <input type="email" id="login-email" class="inp-login" placeholder="Email">
            <input type="password" id="login-pass" class="inp-login" placeholder="Password">
            <button id="loginBtn" class="btn-act-login" onclick="handleLogin()">ENTER SYSTEM</button>
            <div id="login-loader" class="loader" style="margin:10px auto;"></div>
        </div>
        <div id="debug-console">System Booting...<br></div>
        <button class="btn-icon" style="position:absolute; bottom:20px; right:20px; border-color:var(--gold); color:var(--gold);" onclick="requestKeyAccess()">
            <i class="fas fa-key"></i>
        </button>
    </div>

    <div id="keys-modal" class="modal">
        <div class="modal-card">
            <h3 style="color:var(--gold); text-align:center;">SUPABASE KEYS</h3>
            <p style="font-size:11px; color:#888; margin-bottom:15px;">Keys will be stored on this device only.</p>
            <input type="text" id="k-url" class="inp-login" placeholder="Supabase URL">
            <input type="text" id="k-key" class="inp-login" placeholder="Anon Key">
            <button class="btn-act-login" onclick="saveKeys()">SAVE & REBOOT</button>
            <button class="btn-act-login" style="background:#333;color:#888;margin-top:5px;" onclick="closeModal('keys-modal')">CANCEL</button>
        </div>
    </div>

    <div id="dashboard-screen" style="display:none;">
        <div class="header">
            <div class="brand-text">ROYAL SHERWANI</div>
            <div class="header-right">
                <div class="status-box">
                    <div class="dot offline" id="status-dot"></div>
                    <span id="status-text">OFFLINE</span>
                </div>
                <button onclick="logout()" class="btn-logout">LOGOUT</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('inventory')">INVENTORY</button>
            <button class="tab-btn" onclick="switchTab('packed')">PACKED ORDERS</button>
            <button class="tab-btn" onclick="switchTab('master')">MASTER JI</button>
        </div>

        <div id="inventory-view">
            <div class="search-area">
                <input type="text" id="search-input" class="search-input" placeholder="Design Name or Scan Item..." oninput="filterDesigns()">
                <button class="icon-btn" onclick="startSearchScanner()">üì∑</button>
            </div>
            <div id="designs-grid" class="design-grid"></div>
            <div id="main-loader" class="loader"></div>
        </div>

        <div id="packed-view" style="display:none;">
            <div class="split-container">
                <div class="split-col">
                    <div class="col-title" style="color:var(--shop)">üõçÔ∏è SHOP / TRANSIT</div>
                    <div id="shop-packed-list"></div>
                </div>
                <div class="split-col">
                    <div class="col-title" style="color:var(--godown)">üì¶ GODOWN</div>
                    <div id="godown-packed-list"></div>
                </div>
            </div>
            <div id="packed-loader" class="loader"></div>
        </div>

        <div id="master-view" style="display:none;">
            <div class="split-container">
                <div class="split-col">
                    <div class="col-title" style="color:orange">‚è≥ PENDING</div>
                    <div id="master-pending-list"></div>
                </div>
                <div class="split-col">
                    <div class="col-title" style="color:var(--done)">‚úÖ DONE</div>
                    <div id="master-done-list"></div>
                </div>
            </div>
            <div id="master-loader" class="loader"></div>
        </div>
    </div>

    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <button onclick="closeModal('detail-modal')" style="position:absolute; top:10px; right:10px; z-index:10; background:rgba(0,0,0,0.6); color:white; border:none; width:30px; height:30px; border-radius:50%; font-weight:bold;">‚úï</button>
            <div class="modal-img-area"><img id="det-img" src="" class="modal-img"></div>
            <div style="padding:15px; border-bottom:1px solid #333;">
                <h3 id="det-no" style="color:var(--gold)">#0000</h3>
                <span id="det-name" style="color:#ccc; font-size:14px;">Design Name</span>
            </div>
            <div class="stock-list" id="stock-list"></div>
        </div>
    </div>

    <div id="scanner-modal" class="modal">
        <h3 style="color:var(--gold); margin-bottom:20px;">SCAN QR CODE</h3>
        <div id="reader"></div>
        <button onclick="stopScanner()" style="margin-top:20px; background:#333; color:white; padding:10px 30px; border:none; border-radius:20px;">CLOSE</button>
    </div>

    <script>
        // --- LOGGING ---
        function log(msg, type='info') {
            const consoleBox = document.getElementById('debug-console');
            const colorClass = type === 'error' ? 'log-err' : (type === 'success' ? 'log-ok' : 'log-warn');
            const time = new Date().toLocaleTimeString();
            consoleBox.innerHTML += `<div class="${colorClass}">[${time}] ${msg}</div>`;
            consoleBox.scrollTop = consoleBox.scrollHeight;
        }

        // --- STORAGE KEYS HANDLING ---
        let SUPABASE_URL = localStorage.getItem('RS_SB_URL') || '';
        let SUPABASE_KEY = localStorage.getItem('RS_SB_KEY') || '';

        function requestKeyAccess() {
            const code = prompt("Enter Access Code:");
            if(code === "5563990") {
                document.getElementById('k-url').value = SUPABASE_URL;
                document.getElementById('k-key').value = SUPABASE_KEY;
                document.getElementById('keys-modal').style.display = 'flex';
            } else { alert("Unauthorized Access!"); }
        }

        function saveKeys() {
            const u = document.getElementById('k-url').value.trim();
            const k = document.getElementById('k-key').value.trim();
            if(u && k) {
                localStorage.setItem('RS_SB_URL', u);
                localStorage.setItem('RS_SB_KEY', k);
                alert("Keys Saved. App will reload.");
                location.reload();
            } else { alert("Please fill both fields."); }
        }

        var salesClient = null;
        var retryCount = 0;
        let allDesigns=[], allItems=[], html5QrCode=null;

        const safeStorage = {
            getItem: (k) => { try { return localStorage.getItem(k); } catch(e) { return null; } },
            setItem: (k,v) => { try { localStorage.setItem(k,v); } catch(e) {} },
            removeItem: (k) => { try { localStorage.removeItem(k); } catch(e) {} }
        };

        // --- APP INITIALIZATION ---
        function initApp() {
            log("System Booting...");
            if(!SUPABASE_URL || !SUPABASE_KEY) {
                log("‚ö†Ô∏è Keys missing. Tap Key Icon.", 'error');
                return;
            }
            var checkInterval = setInterval(function() {
                if (typeof window.supabase !== 'undefined') {
                    clearInterval(checkInterval);
                    try {
                        salesClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                            auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false }
                        });
                        log("‚úÖ Library Loaded");
                        checkSavedLogin();
                    } catch (e) { log("‚ùå Init Fail: " + e.message, 'error'); }
                } else {
                    retryCount++;
                    if (retryCount > 40) { clearInterval(checkInterval); log("‚ùå Lib Error.", 'error'); }
                }
            }, 500);
        }

        window.onload = initApp;

        function checkSavedLogin() {
            const e = safeStorage.getItem('royal_email');
            const p = safeStorage.getItem('royal_pass');
            if(e && p) {
                log("‚ôªÔ∏è Auto-Logging in...");
                document.getElementById('login-email').value = e;
                document.getElementById('login-pass').value = p;
                handleLogin();
            } else { log("‚ÑπÔ∏è Please Login."); }
        }

        async function handleLogin() {
            const e = document.getElementById('login-email').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            if(!e || !p || !salesClient) return;
            document.getElementById('login-loader').style.display = 'block';
            const { error } = await salesClient.auth.signInWithPassword({ email: e, password: p });
            document.getElementById('login-loader').style.display = 'none';
            if (error) { log("‚ùå " + error.message, 'error'); } 
            else {
                log("‚úÖ Login Success!");
                safeStorage.setItem('royal_email', e);
                safeStorage.setItem('royal_pass', p);
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard-screen').style.display = 'block';
                setInterval(checkConnection, 3000); 
                checkConnection();
                loadInventory();
            }
        }

        function logout() { safeStorage.removeItem('royal_pass'); location.reload(); }

        async function checkConnection() {
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');
            if (navigator.onLine && salesClient) {
                const { error } = await salesClient.from('designs').select('design_no').limit(1).maybeSingle();
                if (!error) { dot.className = 'dot online'; txt.innerText = "ONLINE"; } 
                else { dot.className = 'dot offline'; txt.innerText = "DB ERROR"; }
            } else { dot.className = 'dot offline'; txt.innerText = "NO NET"; }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('inventory-view').style.display = 'none';
            document.getElementById('packed-view').style.display = 'none';
            document.getElementById('master-view').style.display = 'none';
            document.getElementById(tab+'-view').style.display = 'block';
            if(tab === 'inventory') loadInventory();
            else if(tab === 'packed') loadPackedOrders();
            else if(tab === 'master') loadMasterStatus();
        }

        async function loadInventory() {
            document.getElementById('main-loader').style.display = 'block';
            try {
                const { data: designs } = await salesClient.from('designs').select('*').order('created_at', { ascending: false });
                const { data: items } = await salesClient.from('items').select('id, design_no, current_location, size').is('bill_number', null).in('current_location', ['GODOWN_STOCK', 'SHOP_FLOOR']);
                allItems = items || [];
                const counts = {};
                allItems.forEach(i => { if(!counts[i.design_no]) counts[i.design_no] = 0; counts[i.design_no]++; });
                allDesigns = (designs || []).map(d => ({ ...d, qty: counts[d.design_no] || 0 }));
                renderGrid(allDesigns);
            } catch(e) { alert(e.message); } finally { document.getElementById('main-loader').style.display = 'none'; }
        }

        function renderGrid(list) {
            const grid = document.getElementById('designs-grid'); grid.innerHTML = '';
            if(!list || list.length === 0) { grid.innerHTML = '<p style="text-align:center; color:#666; grid-column:1/-1;">No Designs Found</p>'; return; }
            list.forEach(d => {
                grid.innerHTML += `<div class="design-card" onclick="openDetail('${d.design_no}', '${d.image_url}', '${d.name}')"><div class="qty-badge">${d.qty} Pcs</div><img src="${d.image_url}" class="card-img" loading="lazy"><div class="card-body"><div class="card-title">#${d.design_no}</div></div></div>`;
            });
        }

        function filterDesigns() {
            const q = document.getElementById('search-input').value.trim().toLowerCase();
            const matches = allDesigns.filter(d => d.design_no.toLowerCase().includes(q) || d.name.toLowerCase().includes(q));
            renderGrid(matches);
        }

        function startSearchScanner() {
            document.getElementById('scanner-modal').style.display='flex';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (txt) => {
                stopScanner();
                const { data: item } = await salesClient.from('items').select('design_no').eq('id', txt).single();
                if(item) {
                    const matches = allDesigns.filter(d => d.design_no === item.design_no);
                    renderGrid(matches);
                    if(matches.length > 0) openDetail(matches[0].design_no, matches[0].image_url, matches[0].name);
                } else alert("Item not found");
            });
        }

        async function openDetail(no, img, name) {
            document.getElementById('det-img').src = img; document.getElementById('det-no').innerText = "#" + no; document.getElementById('det-name').innerText = name;
            document.getElementById('detail-modal').style.display = 'flex';
            const list = document.getElementById('stock-list'); list.innerHTML = '';
            const filtered = allItems.filter(i => i.design_no === no).sort((a,b) => a.size - b.size);
            if(filtered.length === 0) list.innerHTML = '<p style="text-align:center; color:#666;">Out of Stock</p>';
            filtered.forEach(i => {
                const isShop = i.current_location === 'SHOP_FLOOR';
                list.innerHTML += `<div class="stock-item ${isShop ? 'shop' : 'godown'}"><div><div style="font-weight:bold;color:white">Size: ${i.size}</div><div style="font-size:10px;color:${isShop?'var(--shop)':'var(--godown)'}">${isShop?'IN SHOP':'IN GODOWN'}</div><span class="qr-id">${i.id}</span></div></div>`;
            });
        }

        async function loadPackedOrders() {
            document.getElementById('packed-loader').style.display = 'block';
            const { data: items } = await salesClient.from('items').select('*, designs(name)').in('current_location', ['GODOWN_PACKED', 'SHOP_PACKED', 'TRANSIT_TO_GODOWN']).order('packet_id');
            const sList = document.getElementById('shop-packed-list'); const gList = document.getElementById('godown-packed-list');
            sList.innerHTML = ''; gList.innerHTML = '';
            document.getElementById('packed-loader').style.display = 'none';
            if(!items) return;
            const grouped = {};
            items.forEach(item => {
                const pkt = item.packet_id || 'UNKNOWN';
                if (!grouped[pkt]) grouped[pkt] = { loc: item.current_location, bills: {} };
                const bill = item.bill_number || 'NO_BILL';
                if (!grouped[pkt].bills[bill]) grouped[pkt].bills[bill] = [];
                grouped[pkt].bills[bill].push(item);
            });
            for (const [pktId, data] of Object.entries(grouped)) {
                let billsHtml = '';
                for (const [billNo, items] of Object.entries(data.bills)) {
                    let itemsHtml = '';
                    items.forEach(i => { itemsHtml += `<div class="item-row-packed"><div>${i.designs?.name} (${i.size})</div><span>${i.id}</span></div>`; });
                    billsHtml += `<div class="bill-group"><div class="bill-header">BILL #${billNo}</div>${itemsHtml}</div>`;
                }
                let actionHtml = '', statusIcon = 'üì¶', borderColor = 'var(--gold)';
                if (data.loc === 'SHOP_PACKED') { statusIcon = 'üè¨'; actionHtml = `<button class="btn-send" onclick="sendPacketToGodown('${pktId}')">SEND TO GODOWN ‚ûî</button>`; }
                else if (data.loc === 'TRANSIT_TO_GODOWN') { statusIcon = 'üöö'; borderColor = 'var(--transit)'; actionHtml = `<div class="transit-label">üöö TRANSIT TO GODOWN</div>`; }
                const cardHtml = `<div class="pkt-card" style="border-color:${borderColor}"><div class="pkt-header"><span>${pktId}</span><span>${statusIcon}</span></div><div class="pkt-body">${billsHtml}${actionHtml}</div></div>`;
                if (data.loc === 'SHOP_PACKED' || data.loc === 'TRANSIT_TO_GODOWN') sList.innerHTML += cardHtml; else gList.innerHTML += cardHtml;
            }
        }

        async function sendPacketToGodown(pktId) {
            if(!confirm(`Send Packet ${pktId} to Godown?`)) return;
            const { error } = await salesClient.from('items').update({ current_location: 'TRANSIT_TO_GODOWN' }).eq('packet_id', pktId);
            if(error) alert(error.message); else loadPackedOrders();
        }

        async function loadMasterStatus() {
            document.getElementById('master-loader').style.display = 'block';
            const { data: items } = await salesClient.from('items').select('*, designs(name)').in('current_location', ['MASTER_PENDING', 'MASTER_WORKING', 'MASTER_COMPLETED']).order('bill_number', {ascending:true});
            const pList = document.getElementById('master-pending-list'); const dList = document.getElementById('master-done-list');
            pList.innerHTML = ''; dList.innerHTML = '';
            document.getElementById('master-loader').style.display = 'none';
            if(!items) return;
            items.forEach(i => {
                const isDone = i.current_location === 'MASTER_COMPLETED';
                const statusTxt = i.current_location.replace('MASTER_', '');
                const html = `<div class="master-card ${isDone?'done':''}"><div style="color:var(--gold);font-weight:bold;">Bill #${i.bill_number}</div><div style="color:white">${i.designs?.name}</div><div style="font-size:10px;color:#888">${statusTxt}</div></div>`;
                if(isDone) dList.innerHTML += html; else pList.innerHTML += html;
            });
        }

        function stopScanner() { if(html5QrCode) html5QrCode.stop().catch(()=>{}); document.getElementById('scanner-modal').style.display='none'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
    </script>
</body>
</html>
